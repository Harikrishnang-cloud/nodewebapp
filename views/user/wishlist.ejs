<%- include('../partials/user/header') %>

<div class="container mt-5">
    <h3 class="mb-4">My Wishlist</h3>
    
    <% if (wishlistItems && wishlistItems.length > 0) { %>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Product Name</th>
                        <th>Description</th>
                        <th>Regular Price</th>
                        <th>Sale Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% wishlistItems.forEach(product => { %>
                        <tr>
                            <td>
                                <% if (product.productImage && product.productImage.length > 0) { %>
                                    <img src="/uploads/<%= product.productImage[0] %>" alt="<%= product.name %>" style="height: 100px; width: 100px; object-fit: cover;">
                                <% } else { %>
                                    <img src="/uploads/default-product.jpg" alt="<%= product.name %>" style="height: 100px; width: 100px; object-fit: cover;">
                                <% } %>
                            </td>
                            <td><%= product.productName %></td>
                            <td><%= product.description %></td>
                            <td class="price-strike"><strike>₹<%= product.regularPrice %></strike></td>
                            <td class="price-sale">₹<%= product.salePrice %></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm add-to-cart" data-product-id="<%= product._id %>">
                                        Add to Cart
                                    </button>
                                    <button class="btn btn-danger btn-sm remove-from-wishlist" data-product-id="<%= product._id %>">
                                        Remove
                                    </button>
                                </div>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    <% } else { %>
        <div class="text-center">
            <p>Your wishlist is empty</p>
            <a href="/shop" class="btn btn-primary">Continue Shopping</a>
        </div>
    <% } %>
</div>

<style>
    .btn-sm {
        font-size: 0.8rem;
        padding: 0.50rem 1.5rem;
    }

    .table img {
        transition: transform 0.3s ease;
        border-radius: 8px;
    }

    .table img:hover {
        transform: scale(1.05);
    }

    .table td {
        vertical-align: middle;
    }

    .price-strike {
        color: #6c757d;
        font-size: 0.9em;
    }

    .price-sale {
        color: #dc3545;
        font-weight: bold;
        font-size: 1.1em;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    // Function to update counts
    const updateCounts = () => {
        // Dispatch event to update wishlist count
        window.dispatchEvent(new Event('wishlistUpdated'));
    };

    // Add to Cart
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', async function() {
            const productId = this.getAttribute('data-product-id');
            const row = this.closest('tr');
            
            try {
                // First add to cart
                const cartResponse = await fetch('/addToCart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        id: productId,
                        quantity: 1
                    })
                });

                if (!cartResponse.ok) {
                    throw new Error('Failed to add to cart');
                }

                const cartData = await cartResponse.json();
                
                if (cartData.success) {
                    // If added to cart successfully, remove from wishlist
                    const wishlistResponse = await fetch('/removeFromWishlist', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ productId: productId })
                    });

                    if (!wishlistResponse.ok) {
                        throw new Error('Failed to remove from wishlist');
                    }

                    const wishlistData = await wishlistResponse.json();

                    if (wishlistData.success) {
                        // Update counts
                        updateCounts();

                        // Remove the row with animation
                        row.style.transition = 'opacity 0.5s';
                        row.style.opacity = '0';
                        setTimeout(() => {
                            row.remove();
                            // If no items left, refresh the page to show empty state
                            if (document.querySelectorAll('tbody tr').length === 0) {
                                location.reload();
                            }
                        }, 500);

                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: 'Product added to cart and removed from wishlist',
                            showConfirmButton: true,
                            confirmButtonText: "OK",
                            timer: 1500
                        });
                    }
                } else {
                    throw new Error(cartData.message || 'Failed to add to cart');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: error.message || 'Failed to process your request'
                });
            }
        });
    });

    // Remove from Wishlist
    document.querySelectorAll('.remove-from-wishlist').forEach(button => {
        button.addEventListener('click', async function() {
            try {
                const productId = this.getAttribute('data-product-id');
                const row = this.closest('tr');

                const response = await fetch('/removeFromWishlist', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ productId: productId })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                if (data.success) {
                    // Update counts
                    updateCounts();

                    // Remove the row with animation
                    row.style.transition = 'opacity 0.5s';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        // If no items left, refresh the page to show empty state
                        if (document.querySelectorAll('tbody tr').length === 0) {
                            location.reload();
                        }
                    }, 500);

                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Product removed from wishlist',
                        showConfirmButton: true,
                        confirmButtonText: "OK",
                        timer: 1500
                    });
                } else {
                    throw new Error(data.message || 'Failed to remove from wishlist');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: error.message || 'Failed to remove product from wishlist'
                });
            }
        });
    });
});
</script>

<%- include('../partials/user/footer') %>